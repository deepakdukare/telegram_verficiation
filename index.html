<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar Authentication</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.6s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: #4CAF50;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: scaleIn 0.5s ease-out 0.3s both;
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
            }
            to {
                transform: scale(1);
            }
        }
        
        .success-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 3;
            fill: none;
        }
        
        .error-icon {
            width: 80px;
            height: 80px;
            background: #f44336;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: scaleIn 0.5s ease-out 0.3s both;
        }
        
        .error-icon svg {
            width: 40px;
            height: 40px;
            stroke: white;
            stroke-width: 3;
            fill: none;
        }
        
        h1 {
            color: #333;
            margin: 0 0 15px;
            font-size: 24px;
            font-weight: 600;
        }
        
        p {
            color: #666;
            margin: 0 0 30px;
            line-height: 1.6;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .close-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .close-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .error-details {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            color: #856404;
            text-align: left;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            color: #666;
            display: none;
        }
        
        .show-debug {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-state">
            <div class="loading"></div>
            <h1>Processing Authentication...</h1>
            <p>Please wait while we complete your Google Calendar setup.</p>
        </div>
        
        <div id="success-state" style="display: none;">
            <div class="success-icon">
                <svg viewBox="0 0 24 24">
                    <polyline points="9,11 12,14 22,4"></polyline>
                    <path d="m21,4v13a3,3 0 0,1 -3,3H6a3,3 0 0,1 -3,-3V7a3,3 0 0,1 3,-3h9"></path>
                </svg>
            </div>
            <h1>Authentication Successful! ✅</h1>
            <p>Your Google Calendar has been successfully connected! Redirecting you back to Telegram...</p>
            <button class="close-button" onclick="redirectToTelegram()">Go to Telegram Bot</button>
        </div>
        
        <div id="error-state" style="display: none;">
            <div class="error-icon">
                <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            </div>
            <h1>Authentication Failed ❌</h1>
            <p id="error-message">Something went wrong during authentication. Please try again.</p>
            <div class="error-details" id="error-details" style="display: none;"></div>
            <div class="show-debug" onclick="toggleDebug()">Show Debug Information</div>
            <div class="debug-info" id="debug-info"></div>
            <button class="close-button" onclick="redirectToTelegram()">Try Telegram Again</button>
        </div>
    </div>

    <script>
        // Configuration - Direct Telegram redirect approach
        const CONFIG = {
            TELEGRAM_BOT_USERNAME: 'YOUR_BOT_USERNAME', // Replace with your bot's username (without @)
            AUTO_REDIRECT_DELAY: 2000, // Redirect to Telegram after 2 seconds on success
            // All token exchange happens server-side via direct API calls
        };

        // Get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                state: params.get('state'),
                error: params.get('error'),
                error_description: params.get('error_description')
            };
        }

        // Exchange authorization code for tokens (direct Google API call)
        async function exchangeCodeForTokens(code) {
            const response = await fetch('https://oauth2.googleapis.com/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    code: code,
                    client_id: '137807353004-1fb5tmhiguimvek1cc28msnsmgpfbb0e.apps.googleusercontent.com',
                    client_secret: 'YOUR_NEW_CLIENT_SECRET_HERE', // Update with your new secret
                    redirect_uri: window.location.origin + window.location.pathname,
                    grant_type: 'authorization_code'
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`Token exchange failed: ${errorData.error_description || errorData.error || response.statusText}`);
            }

            return await response.json();
        }

        // Send token data to Google Sheets directly
        async function storeTokensInSheet(tokenData, chatId) {
            // This would typically use Google Sheets API
            // For now, we'll simulate success and rely on your n8n workflow
            // to handle token storage through other means
            
            console.log('Tokens obtained successfully:', {
                chatId: chatId,
                hasAccessToken: !!tokenData.access_token,
                hasRefreshToken: !!tokenData.refresh_token,
                expiresIn: tokenData.expires_in
            });
            
            // In a real implementation, you might:
            // 1. Store tokens in localStorage temporarily
            // 2. Include them in the Telegram redirect URL (not recommended for security)
            // 3. Use a different secure method to pass them to your bot
            
            return { success: true };
        }

        // Show success state and redirect to Telegram
        function showSuccess() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('success-state').style.display = 'block';
            
            // Auto redirect to Telegram after delay
            setTimeout(() => {
                redirectToTelegram();
            }, CONFIG.AUTO_REDIRECT_DELAY);
        }

        // Show error state
        function showError(message, details = null) {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = message;
            
            if (details) {
                document.getElementById('error-details').textContent = details;
                document.getElementById('error-details').style.display = 'block';
            }
        }

        // Toggle debug information
        function toggleDebug() {
            const debugInfo = document.getElementById('debug-info');
            const params = getUrlParams();
            
            debugInfo.innerHTML = `
                <strong>Debug Information:</strong><br>
                URL: ${window.location.href}<br>
                Params: ${JSON.stringify(params, null, 2)}<br>
                User Agent: ${navigator.userAgent}<br>
                Timestamp: ${new Date().toISOString()}
            `;
            
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        // Redirect to Telegram bot
        function redirectToTelegram() {
            const telegramUrl = `https://t.me/${CONFIG.TELEGRAM_BOT_USERNAME}`;
            
            // Try to open Telegram app first, fallback to web
            try {
                // For mobile devices, try to open Telegram app
                if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    window.location.href = `tg://resolve?domain=${CONFIG.TELEGRAM_BOT_USERNAME}`;
                    
                    // Fallback to web version after a short delay
                    setTimeout(() => {
                        window.location.href = telegramUrl;
                    }, 1500);
                } else {
                    // For desktop, open web version
                    window.location.href = telegramUrl;
                }
            } catch (e) {
                // If anything fails, use web version
                window.location.href = telegramUrl;
            }
        }

        // Main authentication handler
        async function handleAuth() {
            const params = getUrlParams();
            
            try {
                // Check for OAuth errors
                if (params.error) {
                    throw new Error(params.error_description || params.error);
                }

                // Check if we have required parameters
                if (!params.code || !params.state) {
                    throw new Error('Missing authorization code or state parameter');
                }

                const chatId = params.state;
                
                // Exchange code for tokens
                console.log('Exchanging authorization code for tokens...');
                const tokenData = await exchangeCodeForTokens(params.code);
                
                // Store tokens (you'll need to implement this based on your needs)
                console.log('Storing tokens...');
                await storeTokensInSheet(tokenData, chatId);
                
                // Show success
                showSuccess();
                
            } catch (error) {
                console.error('Authentication error:', error);
                showError(
                    error.message || 'An unexpected error occurred during authentication',
                    error.stack
                );
            }
        }

        // Start the authentication process when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Add some delay to show the loading state
            setTimeout(handleAuth, 1000);
        });

        // Handle page visibility change (when user returns to tab)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && document.getElementById('success-state').style.display === 'block') {
                // If success state is showing and user returned to tab, redirect after short delay
                setTimeout(redirectToTelegram, 1000);
            }
        });
    </script>
</body>
</html>